## Prompt pour nouveau chat

Je suis Patrick.
Je d√©veloppe une appli Android Kotlin/Compose appel√©e **LrcReader_EXO**.

C‚Äôest un lecteur de playback avec :
- Paroles synchronis√©es (PlayerScreen, MANU/AUTO, prompteur)
- Playlists rapides + playlists compl√®tes
- Mode DJ
- Fond sonore automatique entre les morceaux
- Sauvegarde globale en JSON (BackupManager)
- R√©glage gain & tempo par morceau

Je vais t‚Äôenvoyer les fichiers :
- `MainActivity.kt`
- `PlayerScreen.kt`
- `HomeScreen.kt`
- `MoreScreen.kt`
- et d‚Äôautres si besoin.

Tu m‚Äôaides √† :
- corriger les bugs
- nettoyer le code
- ajouter des fonctionnalit√©s
- sans casser ce qui marche d√©j√†.
R√©ponds avec du code complet, pr√™t √† coller.# Plan du projet ‚Äî LrcReader_EXO


Application Android (Kotlin + Jetpack Compose) pour :
- Lire des playbacks
- Afficher des paroles synchronis√©es (.lrc)
- G√©rer des playlists rapides & compl√®tes
- Mode DJ / crossfade
- Fond sonore automatique
- Sauvegarde/restauration globale en JSON
- R√©glages par morceau (gain, tempo)
- Outils bonus : accordeur, √©dition de points d‚Äôentr√©e/sortie, etc.

---

## 1. Navigation & activit√© principale

### 1.1. Activit√© principale

- `exo/MainActivity.kt`
- Initialise :
- `MediaPlayer`
- `LoudnessEnhancer`
- `DjEngine.init(context)`
- Restauration auto : `AutoRestore.restoreIfNeeded(context)`
- G√®re l‚Äôonglet s√©lectionn√© (`BottomTab`) via :
- `selectedTab: BottomTab`
- `SessionPrefs.getTab(...)` / `SessionPrefs.saveTab(...)`
- G√®re l‚Äô√©tat global :
- `currentPlayingUri`
- `isPlaying`
- `parsedLines: List<LrcLine>`
- `currentTrackGainDb`
- `currentTrackTempo`
- `currentLyricsColor`
- `selectedQuickPlaylist`
- `openedPlaylist`
- Applique le volume & tempo :
- `applyGainToPlayer(db)`
- `applyTempoToPlayer(speed)`
- Fonction centrale de lecture :
- `playWithCrossfade(uriString, playlistName?)`
- Appelle `crossfadePlay(...)`
- Charge les paroles via `LrcStorage.loadForTrack(...)` puis `parseLrc(...)`
- G√®re :
- d√©marrage / arr√™t du fond sonore (`FillerSoundManager`)
- erreur de lecture
- fin naturelle

### 1.2. Tabs / Bottom navigation

- `ui/BottomTabsBar.kt` (nom √† adapter selon ton projet)
- Barre du bas (Home / Lecteur / Quick / Library / All / More / DJ / Tuner)

- `ui/BottomTab.kt` (ou similaire)
- `sealed class BottomTab { Home, Player, QuickPlaylists, Library, AllPlaylists, More, Dj, Tuner }`

- Conversion tab <-> String (dans `MainActivity.kt`) :
- `tabKeyOf(tab: BottomTab): String`
- `tabFromKey(key: String): BottomTab`

---

## 2. √âcrans UI

### 2.1. Accueil

- `ui/HomeScreen.kt`
R√¥le :
- √âcran d‚Äôaccueil ‚Äúpro‚Äù, inspir√© Suno.
- Fond d√©grad√© bleu/violet.
- Gros boutons :
- **Mode Lecteur** ‚Üí ouvre l‚Äôonglet Player
- **Mode Concert** ‚Üí active `DisplayPrefs.setConcertMode(true)` + Player
- **Mode DJ / Mix** ‚Üí onglet Dj
- **Accordeur** ‚Üí onglet Tuner
- Petits chips en bas :
- Profil (placeholder)
- Tutoriel ‚Üí onglet More
- Notes ‚Üí actuellement redirig√© vers `BottomTab.More` (premi√®re version)
- R√©glages ‚Üí onglet More

Composants :
- `NeonCardButton(...)` : grosses cartes n√©on.
- `SmallBottomChip(...)` : petites ic√¥nes/labels en bas.

---

### 2.2. Lecteur (Player)

- `ui/PlayerScreen.kt`

R√¥le :
- √âcran principal de lecture (paroles + musique).
- G√®re :
- Paroles en mode **MANU** (scroll manuel + centrage ligne)
- Mode **AUTO** = prompteur √† d√©filement continu
- Mode **Concert** (DisplayPrefs)
- Contr√¥les lecture : Play/Pause, Prev, Next
- TimeBar (seek)
- R√©sum√© ‚ÄúDJ‚Äù du morceau :
- Gain (dB) + tempo (speed)

Principaux √©l√©ments :

- Suivi de lecture :
- `durationMs`, `positionMs`, `isDragging`, `dragPosMs`
- `LaunchedEffect(isPlaying, parsedLines)` pour :
- mettre √† jour dur√©e & position
- calculer `currentLrcIndex` (ligne active)
- Affichage des paroles ‚ÄúMANU‚Äù :
- `LyricsArea(...)`
- Utilise `scrollState`, `lyricsBoxHeightPx`, `baseTopSpacerPx`, `lineHeightPx`
- `currentLrcIndex` pour surligner la ligne en cours
- clic sur une ligne ‚Üí `seekAndCenter(targetMs, index)`
- Affichage des paroles ‚ÄúAUTO / prompteur‚Äù :
- `PrompterArea(...)`
- Texte unique construit via `buildPrompterText(parsedLines, rawLyricsText)`
- Scroll continu via `prompterScrollState` + `LaunchedEffect(isPrompterRunning, ...)`
- Vitesse r√©glable (`PrompterPrefs.getSpeed/saveSpeed`)
- Header :
- `ReaderHeader(...)`
- Toggle mode concert (ic√¥ne ‚ÄúTune‚Äù)
- Bouton MANU/AUTO
- Bouton Mix (ouvre `TrackMixScreen`)
- Bouton √âditer (ouvre `LyricsEditorSection`)
- Mix :
- `TrackMixScreen(...)`
- Gain dB ‚Üí utilise `TrackVolumePrefs`, `applyGainToPlayer(...)`
- Tempo (speed) ‚Üí `TrackTempoPrefs`, `applyTempoToPlayer(...)`
- √âditeur de paroles :
- `LyricsEditorSection(...)`
- Onglets texte / lignes / timing (√† adapter selon impl√©mentation)
- Utilise `LrcStorage.saveForTrack(...)`
- `onSaveSortedLines(sortedLines)` ‚Üí met √† jour `parsedLines`

---

### 2.3. √âcran ‚ÄúPlus‚Äù (Param√®tres)

- `ui/MoreScreen.kt`

R√¥le :
- Menu ‚ÄúParam√®tres‚Äù avec sous-√©crans :
- Fond sonore (nappe)
- Sauvegarde/Restauration
- √âdition de titre
- (Placeholders : Interface / Audio / Avanc√©)

Structure :
- `MoreScreen(...)` :
- G√®re une `MoreSection` :
- `Root`, `Backup`, `Filler`, `Edit`
- `MoreRootScreen(...)` :
- Boutons :
- üéß Fond sonore ‚Üí `FillerSoundScreen`
- üíæ Sauvegarde / Restauration ‚Üí `BackupScreen`
- üõ† √âdition de titre ‚Üí `EditSoundScreen`

---

### 2.4. Sauvegarde / Restauration

- Dans `ui/MoreScreen.kt` : `BackupScreen(...)`

R√¥le :
- Exporter l‚Äô√©tat complet en JSON.
- Importer un JSON pour restaurer.
- Naviguer dans un dossier de sauvegarde (SAF / DocumentTree).

Fonctionnement :
- `BackupManager.exportState(context, null, emptyList())` ‚Üí JSON complet.
- `BackupManager.importState(context, json, onDone)` ‚Üí restaure l‚Äô√©tat.

Export :
- Bouton **Enregistrer dans‚Ä¶**
- G√©n√®re un JSON
- Utilise `ActivityResultContracts.CreateDocument("application/json")`
- Nom par d√©faut propos√© : `lrc_backup_YYYY-MM-DD_HH-mm-ss.json`
- L‚Äôutilisateur peut modifier le nom.
- Ecriture dans le `Uri` via `saveJsonToUri(...)`
- Bouton **Partager**
- `shareJson(context, fileName, json)` ‚Üí envoie le JSON via les apps de partage.

Dossier de sauvegarde :
- S√©lection via `ActivityResultContracts.OpenDocumentTree()`
- Permissions persistantes `takePersistableUriPermission(...)`
- Sauvegarde du dossier dans `BackupFolderPrefs`.

Listing des sauvegardes :
- `DocumentFile.fromTreeUri(...)` + filtre `.json`
- Affichage des fichiers + bouton **Importer**
- Lit le JSON
- Appelle `BackupManager.importState(...)`

---

### 2.5. Fond sonore (nappe)

- `ui/MoreScreen.kt` : `FillerSoundScreen(...)`
- `core/FillerSoundManager.kt`
- `core/FillerSoundPrefs.kt`

R√¥le :
- Lancer une ‚Äúnappe‚Äù audio en fond apr√®s la fin d‚Äôun titre.
- Permettre de tester/preview.
- ON/OFF et volume d√©di√©.

Fonctionnalit√©s :
- `Switch` pour activer/d√©sactiver le fond sonore (`FillerSoundPrefs.isEnabled/setEnabled`)
- Choix d‚Äôun dossier audio via `OpenDocumentTree`
- Dossier stock√© dans `FillerSoundPrefs.getFillerFolder/saveFillerFolder`
- Volume :
- Slider UI (0..1), mapp√© en volume r√©el via courbe `u¬≥` (pour meilleure finesse en bas)
- Sauvegarde dans `FillerSoundPrefs.saveFillerVolume`
- Application via `FillerSoundManager.setVolume(real)`
- Preview :
- Bouton **‚ñ∂Ô∏é √âcouter / Arr√™ter l‚Äô√©coute**
- `FillerSoundManager.startIfConfigured(context)`
- `FillerSoundManager.fadeOutAndStop(200)`

---

### 2.6. √âdition de titre (points d‚Äôentr√©e/sortie)

- `ui/MoreScreen.kt` : `EditSoundScreen(...)`
- `core/EditSoundPrefs.kt`

R√¥le :
- Choisir un fichier audio et r√©gler :
- Point d‚Äôentr√©e (startMs)
- Point de sortie (endMs)
- Sauvegarder ces valeurs par URI.

Fonctionnalit√©s :
- Choix du fichier audio (`GetContent("audio/*")`)
- Lecture simple via `MediaPlayer` local :
- Lecture du segment complet
- Lecture des 10 derni√®res secondes
- Bouton Stop
- Sliders pour :
- Start
- End
- Sauvegarde via `EditSoundPrefs.save(context, uri, startMs, endMs)`

---

### 2.7. DJ

- `ui/DjScreen.kt`
- `core/dj/DjEngine.kt`

R√¥le :
- Interface pour le mode DJ :
- Crossfade entre deux decks
- Gestion du tempo, etc. (selon impl√©mentation actuelle)

Initialisation :
- `DjEngine.init(context)` dans `MainActivity.onCreate`

---

### 2.8. Accordeur (Tuner)

- `ui/TunerScreen.kt`

R√¥le :
- Analyse du micro pour afficher la note jou√©e (guitare & co).

Navigation :
- Depuis `HomeScreen` ‚Üí on s√©lectionne `BottomTab.Tuner`
- Dans `TunerScreen`, callback `onClose()` renvoie √† `BottomTab.Home`.

---

### 2.9. Playlists / Library

Fichiers (noms √† adapter selon ton projet) :

- `ui/QuickPlaylistsScreen.kt`
- Affiche les playlists ‚Äúrapides‚Äù
- `onPlaySong(uri, playlistName, color)` :
- Appelle `playWithCrossfade(...)`
- Sauvegarde la playlist rapide s√©lectionn√©e (`SessionPrefs.saveQuickPlaylist`)
- Sauvegarde la couleur des paroles
- `ui/LibraryScreen.kt`
- Affichage g√©n√©ral de la ‚Äúbiblioth√®que‚Äù (tous les titres), selon ton impl√©mentation.
- `ui/AllPlaylistsScreen.kt`
- Liste toutes les playlists
- `onPlaylistClick(name)` ‚Üí ouvre `PlaylistDetailScreen`
- `ui/PlaylistDetailScreen.kt`
- Affiche le contenu d‚Äôune playlist donn√©e
- `onPlaySong(uri)` ‚Üí `playWithCrossfade(uri, openedPlaylist)`

R√©f√©rences :
- `core/PlaylistRepository.kt` (ou similaire)
- `PlaylistRepository.version` (StateFlow) utilis√© dans `MainActivity` (`val repoVersion by PlaylistRepository.version`).

---

## 3. Core & logique m√©tier

### 3.1. Sauvegardes & pr√©f√©rences

- `core/BackupManager.kt`
- `exportState(context, ...)` ‚Üí JSON complet
- `importState(context, json, onDone)` ‚Üí applique les donn√©es

- `core/BackupFolderPrefs.kt`
- Stocke `Uri` du dossier de sauvegarde

- `core/SessionPrefs.kt`
- Onglet actuel (`TAB_HOME`, `TAB_PLAYER`, etc.)
- Playlist rapide s√©lectionn√©e
- Playlist ‚ÄúAllPlaylists‚Äù actuellement ouverte

- `core/TrackVolumePrefs.kt`
- Volume d‚Äôun titre (en dB) par URI
- `core/TrackTempoPrefs.kt`
- Tempo d‚Äôun titre (speed) par URI

- `core/DisplayPrefs.kt`
- Mode concert ON/OFF

- `core/PrompterPrefs.kt`
- Vitesse du prompteur

- `core/AutoRestore.kt`
- Restauration automatique d‚Äôun √©ventuel √©tat pr√©c√©dent

---

### 3.2. Paroles & LRC

- `core/LrcLine.kt`
- Mod√®le d‚Äôune ligne de paroles :
- `timeMs`
- `text`

- `core/LrcStorage.kt`
- Sauvegarde/surcharge des .lrc sp√©cifiques √† un morceau :
- `saveForTrack(context, trackUri, lines)`
- `loadForTrack(context, trackUri): String?`

- `core/parseLrc.kt`
- Parse les fichiers LRC en `List<LrcLine>`

- `ui/PlayerScreen.kt`
- Utilise `parseLrc(...)` + `LrcStorage` pour afficher les paroles.

---

### 3.3. Audio & Crossfade

- `core/crossfadePlay.kt`
- G√®re le crossfade entre le morceau courant et le nouveau
- Charge les paroles via callback `onLyricsLoaded(...)`
- G√®re erreurs, fin naturelle, etc.

- `core/pauseWithFade.kt`
- Utilis√© dans `PlayerScreen` pour faire une pause avec fondu sonore.

- `core/FillerSoundManager.kt`
- Gestion de la nappe (fond sonore)
- `startIfConfigured(context)`
- `fadeOutAndStop(durationMs)`
- `setVolume(value)`

---

## 4. Ce qu‚Äôil faut envoyer √† ChatGPT dans un nouveau chat

### 4.1. Prompt ‚Äúbase projet‚Äù

√Ä envoyer en premier :

> Je suis Patrick.
> Je d√©veloppe une appli Android Kotlin/Compose appel√©e **LrcReader_EXO**.
> C‚Äôest un lecteur de playback pour la sc√®ne, avec :
> - Paroles synchronis√©es (PlayerScreen, mode MANU / AUTO prompteur, mode Concert)
> - Playlists rapides + playlists compl√®tes
> - Mode DJ (DjScreen + DjEngine)
> - Fond sonore automatique entre les morceaux
> - Sauvegarde/restauration globale en JSON (BackupManager)
> - R√©glage par morceau : gain (dB) + tempo
>
> Je vais t‚Äôenvoyer les fichiers cl√©s (MainActivity, PlayerScreen, HomeScreen, MoreScreen, etc.).
> Aide-moi √† corriger les bugs, nettoyer le code et ajouter des fonctionnalit√©s,
> **sans casser ce qui marche d√©j√†**.
> R√©ponds avec du code complet, pr√™t √† coller.

### 4.2. Fichiers √† envoyer selon ce que tu veux faire

- **Navigation / nouveau √©cran / bug global**
- `exo/MainActivity.kt`
- `ui/BottomTabsBar.kt` + `BottomTab`
- L‚Äô√©cran concern√©

- **Paroles / synchro / prompteur**
- `ui/PlayerScreen.kt`
- `core/LrcLine.kt`
- `core/parseLrc.kt`
- `core/LrcStorage.kt`

- **Sauvegarde / JSON / backup**
- `ui/MoreScreen.kt` (partie `BackupScreen`)
- `core/BackupManager.kt`
- `core/BackupFolderPrefs.kt`
- `com.patrick.lrcreader.saveJsonToUri` / `shareJson` si besoin

- **Fond sonore / nappe**
- `ui/MoreScreen.kt` (partie `FillerSoundScreen`)
- `core/FillerSoundManager.kt`
- `core/FillerSoundPrefs.kt`

- **√âdition points d‚Äôentr√©e/sortie**
- `ui/MoreScreen.kt` (partie `EditSoundScreen`)
- `core/EditSoundPrefs.kt`

- **Mode DJ**
- `ui/DjScreen.kt`
- `core/dj/DjEngine.kt`

- **Accordeur**
- `ui/TunerScreen.kt`

- **Playlists**
- `ui/QuickPlaylistsScreen.kt`
- `ui/LibraryScreen.kt`
- `ui/AllPlaylistsScreen.kt`
- `ui/PlaylistDetailScreen.kt`
- `core/PlaylistRepository.kt` (ou √©quivalent)

---

## 5. Convention interne (pour toi)

Pour t‚Äôy retrouver vite dans le code, tu peux ajouter en haut de chaque fichier :

```kotlin
// [MAP] UI / Player : √©cran lecteur principal (paroles, MANU/AUTO, mix)